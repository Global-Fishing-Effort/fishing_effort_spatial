---
title: "Untitled"
output: html_document
date: "2024-05-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(xlsx)
library(here)
# library(rnaturalearth)
library(maps)
library(countrycode)
library(sf)

options(scipen = 999) ## To disable scientific notation

```
Read in data

```{r}
cmip_data <- read.xlsx(here("fishmip/data/table_stats_with_continent.xlsm"), sheetIndex = 1) %>%
  dplyr::select(1:15) %>%
    mutate(pos_neg = ifelse(mean > 0, "positive", "negative")) %>% # ~200 regions, makes sense
  mutate(fa_ffcl_shrt = case_when(
   fa_ffcl_shrt == "C√¥te d'Ivoire" ~ "Côte d'Ivoire", 
   fa_ffcl_shrt == "T√ºrkiye" ~ "Türkiye",
   fa_ffcl_shrt == "R√©union" ~ "Réunion",
  fa_ffcl_shrt == "Cura√ßao" ~ "Curaçao",
  TRUE ~ fa_ffcl_shrt
  )) # fix region names

```

Create plot but filtering for just one scenario (ssp585), negative numbers, and one decade

```{r}
# ssp_585 <- cmip_data %>% 
#   filter(scenario == "ssp585", 
#          decade == "2091-2100",
#          spatial_scale == "countries") 

plot_df <- cmip_data %>%
  filter(spatial_scale == "countries")

plot_df$end_point <- max(abs(plot_df$mean), na.rm = TRUE)

# Create the plot
 ggplot(data = plot_df) +
  geom_segment(
    aes(x = reorder(fa_ffcl_shrt, abs(mean)),
        y = 0,
        xend = reorder(fa_ffcl_shrt, abs(mean)),
        yend = end_point),
   # linetype = "dotted",
    color = "gray"
  ) +
  geom_point(
    aes(x = reorder(fa_ffcl_shrt, abs(mean)),
        y = end_point,
        size = abs(mean),
        color = pos_neg),
    shape = 1
  ) +
  coord_polar() +  # Set the polar coordinate system to be half-circle
 # scale_size_continuous(breaks = c(20, 40, 60), labels = c(-20, -40, -60)) +
  labs(size = "mean", x = "", y = "") +
  theme_void() + 
  theme(axis.text.x = element_text(vjust = 1, hjust = 1),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
   facet_grid(decade ~ scenario)

 ## ok this is a mess...
 
```

Use code from food footprint, on one decade/scenario grouping for ease of use

```{r}
plot_df <- cmip_data %>%
  filter(spatial_scale == "countries") %>%
  filter(decade == "2091-2100",
         scenario == "ssp585") %>%
  data.frame() %>%
  arrange(contnnt, pos_neg, abs(mean))

get_pos_neg_ranks <- plot_df %>%
  group_by(contnnt, pos_neg, fa_ffcl_shrt) %>%
  summarise(index = sum(mean, na.rm = TRUE)) %>%
    mutate(new_index = abs(index)) %>%
  arrange(contnnt, pos_neg, -new_index)

rank_pos_neg <- get_pos_neg_ranks %>%
  group_by(contnnt) %>% 
  summarise(sum_mean = sum(new_index),
            count = length(new_index)) %>%
  ungroup()

rank_pos_neg$contnnt <- factor(rank_pos_neg$contnnt, 
                                         levels=unique(rank_pos_neg$contnnt))
get_pos_neg_ranks$contnnt <- factor(get_pos_neg_ranks$contnnt, 
                                         levels=unique(rank_pos_neg$contnnt))

rank_rgn <- get_pos_neg_ranks %>%
  arrange(contnnt, pos_neg, -new_index) %>%
     mutate(rgn_name_short = fa_ffcl_shrt, 
         rgn_name_short = gsub("Islands|islands", "Isl", rgn_name_short),
         rgn_name_short = gsub("Island", "Isl", rgn_name_short),
         rgn_name_short = gsub("Democratic", "Dem", rgn_name_short),
         rgn_name_short = gsub("Republic", "Rep", rgn_name_short),
         rgn_name_short = gsub("South", "S", rgn_name_short),
         rgn_name_short = gsub("American", "Am", rgn_name_short),
         rgn_name_short = gsub("the United States", "US", rgn_name_short),
         rgn_name_short = gsub("Territory", "Terr", rgn_name_short),
         rgn_name_short = gsub("Saint", "St", rgn_name_short),
         rgn_name_short = gsub(" and ", " & ", rgn_name_short),
         rgn_name_short = gsub("Republique", "Rep", rgn_name_short),
         rgn_name_short = gsub("Dem Rep of the", "Dem Rep of", rgn_name_short),
         rgn_name_short = gsub("Georgia and the", "Georgia and", rgn_name_short),
         rgn_name_short = gsub("St Vincent and the", "St Vincent and", rgn_name_short),
         rgn_name_short = gsub("Howland Isl & Baker Isl", "Howland & Baker Isl", rgn_name_short),
         rgn_name_short = gsub("Northern", "N", rgn_name_short), 
         rgn_name_short = gsub("Reunion", "Reunion", rgn_name_short))



# add empty space to create space in the circleplot for axes
 empty_bar <- 5
 to_add <- data.frame(matrix(NA, empty_bar, ncol(rank_rgn)) )
 colnames(to_add) = colnames(rank_rgn)
 to_add$fa_ffcl_shrt <- as.character(1:empty_bar)
 rank_rgn_adj  <- rbind(to_add, rank_rgn)

rank_rgn_adj$end_point <- max(abs(rank_rgn_adj$index), na.rm = TRUE) # point where we will want to place the country labels

 # some code to orient the country labels
sequence_length = length(unique(rank_rgn_adj$fa_ffcl_shrt))
first_sequence = c(1:(sequence_length%/%2)) 
second_sequence = c((sequence_length%/%2+1):sequence_length) 
first_angles = c(90 - 180/length(first_sequence) * first_sequence)
second_angles = c(-90 - 180/length(second_sequence) * second_sequence)
rank_rgn_adj$angle <- c(first_angles, second_angles)
rank_rgn_adj$hjust <- c(rep(0, length(first_sequence)), 
                    rep(1, length(second_sequence)))


# color for region labels
rank_rgn_adj <- rank_rgn_adj %>%
  mutate(fa_ffcl_shrt = factor(fa_ffcl_shrt, unique(fa_ffcl_shrt))) %>%
  mutate(pos_neg = factor(pos_neg, unique(pos_neg))) %>%
  mutate(color = "black") %>%
  mutate(color = ifelse(is.na(index), "white", color)) %>%
  mutate(fill_category = case_when(
    index < -30 ~ "Biomass decrease >30%",
    index <= -20 & index >= -30 ~ "Biomass decrease 20 to 30%",
    index <= -10 & index > -20 ~ "Biomass decrease 10 to 20%",
    index <= 0 & index > -10 ~ "Biomass decrease <10%",
    index >= 0 & index < 10 ~ "Biomass increase <10%",
    index >= 10 & index < 20 ~ "Biomass increase 10 to 20%", 
    index >= 20 & index <= 30 ~ "Biomass increase 20 to 30%",
    index > 30 ~ "Biomass increase >30%"
  )) 


# get dataframe for georegion shift locations
rgn_shift <- rank_rgn_adj %>%
  mutate(contnnt = ifelse(is.na(contnnt), "tmp", contnnt)) %>%
  mutate(contnnt = as.factor(contnnt)) %>%
  mutate(region_shift = as.numeric(contnnt) - lag(as.numeric(contnnt)), default=first(as.numeric(contnnt)))

rgn_shift <- which(rgn_shift$region_shift > 0)
rgn_shift <- c(1, rgn_shift) - 0.5
rgn_shift <- data.frame(
                         contnnt = rank_pos_neg$contnnt,
                         name_x = c(20, 75, 125, 160, 200), # 140
                         name_y = c(55, 55, 55, 55, 55))
rgn_shift <- rgn_shift %>%
   mutate(contnnt = as.character(contnnt))


# Define colors for each fill category
fill_colors <- c(
  "Biomass decrease >30%" = "#AC390E",
  "Biomass decrease 20 to 30%" = "#BA4D27",
  "Biomass decrease 10 to 20%" = "#C4603E",
  "Biomass decrease <10%" = "#CB8567",
  "Biomass increase <10%" = "#87ADDA",
  "Biomass increase 10 to 20%" = "#437BC2",
  "Biomass increase 20 to 30%" = "#286AB9",
  "Biomass increase >30%" = "#0A5BB3"
)

circle_theme <- theme(axis.line=element_blank(),
                      axis.text.y=element_blank(),
                      axis.ticks=element_blank(),
                      axis.title.x=element_blank(),
                      axis.title.y=element_blank(),
                     # legend.position="none",
    legend.position='top', 
        legend.justification='left',
        legend.direction='horizontal',
                      panel.background=element_blank(),
                      panel.border=element_blank(),
                      panel.grid.major=element_blank(),
                      panel.grid.minor=element_blank(),
                      plot.background=element_blank(),
                      axis.text.x = element_blank())

  
## try bar chart; consider splitting by positive negative (like they do with the continents in food footprint plot)
  
  g <- ggplot(data = rank_rgn_adj, aes(x = fa_ffcl_shrt, y = new_index,
        fill = fill_category)) + 
  geom_bar(stat = "identity") +
  geom_errorbar(
     aes(x = 1, 
    ymin = -end_point/4,
    ymax = end_point,
    alpha = 0),
    color = "white"
  ) + 

    geom_text( 
      data = rank_rgn_adj,
       aes(x = fa_ffcl_shrt,
           label = rgn_name_short,
           angle = angle,
           y = end_point,
           hjust = hjust,
               ),
       inherit.aes = FALSE,
       fontface = "bold",
       alpha = 0.9,
       size = 3) +
   geom_segment(
        x = 0,
         y = 0,
         xend = dim(rank_rgn_adj)[1]+1,
         yend = 0,
        alpha = 1,
        color = "white",
        size = 0.1) +
           # georegion names
    geom_text(
      data = rgn_shift,
      aes(y = unique(rank_rgn_adj$end_point)/2,
          x = name_x, 
          label = contnnt),
      inherit.aes=FALSE,
      size=7) +
    annotate("text",
        x     = c(3, 3, 3),
        y     = c(0, unique(rank_rgn_adj$end_point)/2, unique(rank_rgn_adj$end_point)),
        labelx = c("0", "±34%", "±69%"),
        color = "darkgray", angle = -4, size = 5) +
  coord_polar() +
  scale_fill_manual(values = fill_colors, breaks = names(fill_colors)[!is.na(fill_colors)]) +  # Assign colors manually
  circle_theme +
    labs(title = "Biomass change: SSP5-8.5, 2091-2100",
         fill = "") +
    guides(alpha = "none",
           )


  ggsave(here("fishmip/figs/bar_ssp585_2091-2100.png"), height=18, width=18, units=c("in"), bg = "white")
  
  

```


Make plot with increasing size circles

```{r}
g <- ggplot(data = rank_rgn_adj, aes(x = fa_ffcl_shrt, y = 100, size = new_index,
        fill = fill_category,
       # color = fill_category
        )) + 
      scale_fill_manual(values = fill_colors, breaks = names(fill_colors)[!is.na(fill_colors)]) +  # Assign colors manually, remove NA category
        scale_colour_manual(values = fill_colors, breaks = names(fill_colors)[!is.na(fill_colors)]) +  # Assign colors manually
  geom_point(shape = 21,
             alpha = 0.6) +
    geom_point(
    shape = 21,
    color = "black",
    fill = "black",
    size = 0.1
  ) +
    geom_text(
      data = rank_rgn_adj,
       aes(x = fa_ffcl_shrt,
           label = rgn_name_short,
           angle = angle,
           hjust = hjust,
           y = end_point
              ),
       fontface = "bold",
       alpha = 0.9,
       size = 3) +
  #   geom_segment(
  #   aes(x = fa_ffcl_shrt,
  #       y = 1,
  #       xend = reorder(fa_ffcl_shrt, abs(mean)),
  #       yend = end_point),
  #  # linetype = "dotted",
  #   color = "gray"
  # ) +
  # geom_segment(
  #   x = 0,
  #   y = 0, 
  #   xend = dim(plot_df)[1] + 1,
  #              yend = 0, 
  #              fill = NULL, 
  #              alpha = 1, 
  #              color = "white", 
  #              size = 0.1
  # ) + 
  coord_polar() +
  circle_theme +
    labs(title = "Biomass change: SSP5-8.5, 2091-2100",
         fill = "",
         size = "Biomass change") +
    guides(alpha = "none",
           color = "none"
           ) +
    scale_size_continuous(range = c(1, 25),
                          guide = guide_legend(direction = "horizontal"),
                          labels = c("0%", "±20%", "±40%", "±60%")) # Adjust the range of sizes


  ggsave(here("fishmip/figs/circle_ssp585_2091-2100.png"), height=18, width=18, units=c("in"), bg = "white")
  
```

 
Make map of mean change 

```{r}
 ## make map 
 
# world <- map_data("world") %>%
#   mutate(region = ifelse(region %in% c("Antigua", "Barbuda"), "Antigua and Barbuda", region))
# 
# world_df_regions <- world %>% 
#   st_drop_geometry() %>%
#   distinct(region) %>%
#   mutate(iso3c = countrycode(sourcevar = region, origin = "country.name", destination = "iso3c")) %>%
#   mutate(iso3c = case_when(
#     region == "Micronesia" ~ "FSM",
#     TRUE ~ iso3c
#   ))
#  
# 
# ssp_regions <- cmip_data %>%
#   filter(spatial_scale == "countries") %>%
#   distinct(fa_ffcl_shrt) %>%
#     mutate(iso3c = countrycode(sourcevar = fa_ffcl_shrt, origin = "country.name", destination = "iso3c")) %>%
#   left_join(., world_df_regions, by = "iso3c") %>%
#   filter(!is.na(iso3c)) %>%
#   right_join(cmip_data, by = "fa_ffcl_shrt")
# 
# 
# world_subset <- inner_join(world, ssp_regions, by = "region")


plot_df <- cmip_data %>%
  filter(spatial_scale == "countries")

eez_shp <- st_read(here("fishmip/data/"))

eez_key <- read.csv(here("fishmip/data/FAO-Major-Areas_EEZ_continent_keys.csv"))

eez_df <- eez_shp %>% 
 # st_drop_geometry() %>%
  left_join(eez_key) %>%
  right_join(plot_df, by = c("figure_name" = "fa_ffcl_shrt"))

## Let's ditch many of the unnecessary elements
plain <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank(),
  panel.background = element_rect(fill = "white"),
  plot.title = element_text(hjust = 0.5)
)

worldmap <- ggplot(data = eez_df, mapping = aes(x = long, y = lat, group = group)) + 
  coord_fixed(1.3) +
  geom_polygon(aes(fill = mean)) +
  scale_fill_distiller(palette = "RdBu", direction = 1) + # or direction=1
  ggtitle("Mean % change") +
  plain +
  facet_grid(decade~scenario)

  
```


