---
title: "Download global fishing watch fishing effort"
output: html_document
date: "2024-05-14"
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# remotes::install_github("GlobalFishingWatch/gfwr") #install GFW api package

library(gfwr)
library(terra)
library(tidyverse)
library(here)
library(glue)


source(here("R/dir.R"))


# Save API token information to an object every time you need to extract the token and pass it to `gfwr` functions
# The use of gfwr requires a GFW API token, which users can request from the GFW API Portal. Save this token to your .Renviron file (using usethis::edit_r_environ()) by adding a variable named GFW_TOKEN to the file (GFW_TOKEN = "PASTE_YOUR_TOKEN_HERE"). Save the .Renviron file and restart the R session to make the edit effective.
gages_key <- gfw_api_key <- read.delim(file.path(rdsi_raw_dir, "global_fishing_watch/gfw_api_key.txt")) %>%
  colnames() %>%
  unique() # now add this to usethis::edit_r_environ() and restart R. Only need to do this once? 

# gage's key is saved to gage's .Renviron file, which is read by this function
key <- gfw_auth()

```

# Summary

In this script we download spatialized apparent fishing effort from global fishing watch for all years (2012 - 2020): https://globalfishingwatch.org/data-download/datasets/public-fishing-effort


# Data Sources 

## Global Fishing Watch Apparent Fishing Effort

**Reference**:
1. Global Fishing Watch. [2022]. www.globalfishingwatch.org\
2. [`gfwr` API](https://github.com/GlobalFishingWatch/gfwr)

**Downloaded**: May 14, 2024

**Description**: API to extract apparent fishing effort within global EEZ's, labeled with geartype and date.

**Native data resolution**: 0.01 degree

**Time range**: 2012 - 2020

**Format**:  API

## IMAS Country-level Effort data

**Reference**:
1. [Rousseau et al. 2024](https://www.nature.com/articles/s41597-023-02824-6)
2. [IMAS Metadata Catalogue](https://metadata.imas.utas.edu.au/geonetwork/srv/eng/catalog.search#/metadata/1241a51d-c8c2-4432-aa68-3d2bae142794)

**Downloaded**: May 14, 2024

**Description**: Data portal which contains data from Rousseau et al., 2019 and 2024

**Native data resolution**: 0.5 degree

**Time range**: 1950 - 2017

**Format**:  csv

# Methods 

Pull apparent fishing effort data for all EEZs for 2012-2020 from the GFW API and save.

## Get list of iso3c regions

```{r}
# here we read in the country level effort region lookup table  to get a list of regions contained in the effort data
imas_effort_rgns <- read.csv("https://data.imas.utas.edu.au/attachments/1241a51d-c8c2-4432-aa68-3d2bae142794/SAUPtoCountry.csv")

rgn_list <- imas_effort_rgns %>%
  distinct(Country) %>% # 167 countries
  filter(!is.na(Country)) %>%
  filter(Country != "") %>%
  pull() %>%
  unique()

```

## Iterate through all EEZ codes and extract apparent fishing hours

```{r}

years <- c(2012:2020)

## need to do CHN, NOR, RUS (canada/usa border one)

# iterate through all EEZ codes for all regions to extract apparent fishing hours:
for(i in rgn_list) {
  
   # i <- rgn_list[[1]]
  
  # create dataframe that contains the column `id` that is list of all EEZ codes for one region
  eez_code_df <- get_region_id(region_name = i, region_source = 'eez', key = key)
  
  # convert that column into a numeric list of EEZ codes to feed into the next loop:
  eez_codes <- eez_code_df$id
  
  print(paste0("Processing apparent fishing hours for ", i, " EEZ code ", eez_codes))
  
  for(j in eez_codes) { 
   # j = 8323
    sub_region_label = eez_code_df %>% filter(id == j) %>%
      pull(label)
    
    for(y in years){
     # y = 2020
      
    ## might have to change this to yearly... i think GFW has changed the maximum days allowed to process at one time to 366
    fishing_hours <- gfwr::get_raster(spatial_resolution = 'high', # high = 0.01 degree resolution which we think is close to 30 m resolution
                                      temporal_resolution = 'yearly',
                                      group_by = 'flagAndGearType', # maybe change to just geartype
                                      date_range = glue('{y}-01-01,{y}-12-31'), 
                                      region = j, 
                                      region_source = 'eez',
                                      key = key) %>%
      # rename columns for clarity:
      rename(year = "Time Range",
             apparent_fishing_hours = "Apparent Fishing Hours",
             y = Lat,
             x = Lon,
             geartype = Geartype, 
             year = "Time Range",
             number_of_vessels = "Vessel IDs") %>%
      # keep track of the administrative country for each EEZ, even after we combine all data into one dataframe: 
      mutate(eez_admin_rgn = i,
             sub_rgn_label = sub_region_label,
             gfw_id = j) %>% 
      select(year, apparent_fishing_hours, y, x, eez_admin_rgn, geartype, number_of_vessels, sub_rgn_label, gfw_id) # note: we do not care about which region did the actual fishing, just about which country controls that EEZ, which is why we do not maintain the fishing region in the data moving forward
    
    # specify column types before saving the csv so we can correctly concatenate the rows later
    fishing_hours$year <- as.numeric(fishing_hours$year)
    fishing_hours$apparent_fishing_hours <- as.numeric(fishing_hours$apparent_fishing_hours)
    fishing_hours$y <- as.numeric(fishing_hours$y)
    fishing_hours$x <- as.numeric(fishing_hours$x)
    fishing_hours$x <- as.numeric(fishing_hours$x)
    fishing_hours$gfw_id <- as.numeric(fishing_hours$gfw_id)
    
    fishing_hours$eez_admin_rgn <- as.character(fishing_hours$eez_admin_rgn)
    fishing_hours$geartype <- as.character(fishing_hours$geartype)
    fishing_hours$sub_rgn_label <- as.character(fishing_hours$sub_rgn_label)
    
    print(paste0("Extracted all apparent fishing hours for ", i, " EEZ code ",j, " ", sub_region_label, " year ", y))
    
    if(nrow(fishing_hours) == 0){
          print(paste0("Skipping, empty df"))

      next()
    }
    
    write_csv(fishing_hours, glue(rdsi_raw_dir, "/global_fishing_watch/apparent_fishing_hours/{i}_{j}_{y}_annual_effort_grid_highres.csv"))
    
   }
  }
}

```

### Loop through apparent fishing effort for China separately due to the large quantity of data over all years 

```{r}
# Running CHN's first listed EEZ for all years, 2012-2020, breaks the API, so we need to pull data in 3 time chunks

chn_code_eez <- get_region_id(region_name = "CHN", region_source = 'eez', key = key)

# 2012-2015 for first code
chn_eez1_2012_2015 <- gfwr::get_raster(spatial_resolution = 'high',
                             temporal_resolution = 'yearly',
                             group_by = 'flagAndGearType',
                             date_range = '2012-01-01,2015-12-31',
                             region = chn_code_eez$id[1],
                             region_source = 'eez',
                             key = key) %>% 
  # rename columns for clarity:
      rename(year = "Time Range",
             apparent_fishing_hours = "Apparent Fishing hours",
             y = Lat,
             x = Lon,
             geartype = Geartype) %>%
      # keep track of the administrative country for each EEZ, even after we combine all data into one dataframe: 
      mutate(eez_admin_rgn = "CHN") %>% 
      select(year, apparent_fishing_hours, y, x, eez_admin_rgn, geartype) # note: we do not care about which region did the actual fishing, just about which country controls that EEZ, which is why we do not maintain the fishing region in the data moving forward
    
    # specify column types before saving the csv so we can correctly concatenate the rows later
    chn_eez1_2012_2015$year <- as.numeric(chn_eez1_2012_2015$year)
    chn_eez1_2012_2015$apparent_fishing_hours <- as.numeric(chn_eez1_2012_2015$apparent_fishing_hours)
    chn_eez1_2012_2015$y <- as.numeric(chn_eez1_2012_2015$y)
    chn_eez1_2012_2015$x <- as.numeric(chn_eez1_2012_2015$x)
    chn_eez1_2012_2015$eez_admin_rgn <- as.character(chn_eez1_2012_2015$eez_admin_rgn)
    chn_eez1_2012_2015$geartype <- as.character(chn_eez1_2012_2015$geartype)

#  2016-2017 for first code
chn_eez1_2016_2017 <- gfwr::get_raster(spatial_resolution = 'high',
                             temporal_resolution = 'yearly',
                             group_by = 'flagAndGearType',
                             date_range = '2016-01-01,2017-12-31',
                             region = chn_code_eez$id[1],
                             region_source = 'eez',
                             key = key) %>% 
  # rename columns for clarity:
      rename(year = "Time Range",
             apparent_fishing_hours = "Apparent Fishing hours",
             y = Lat,
             x = Lon,
             geartype = Geartype) %>%
      # keep track of the administrative country for each EEZ, even after we combine all data into one dataframe: 
      mutate(eez_admin_rgn = "CHN") %>% 
      select(year, apparent_fishing_hours, y, x, eez_admin_rgn, geartype) # note: we do not care about which region did the actual fishing, just about which country controls that EEZ, which is why we do not maintain the fishing region in the data moving forward
    
    # specify column types before saving the csv so we can correctly concatenate the rows later
    chn_eez1_2016_2017$year <- as.numeric(chn_eez1_2016_2017$year)
    chn_eez1_2016_2017$apparent_fishing_hours <- as.numeric(chn_eez1_2016_2017$apparent_fishing_hours)
    chn_eez1_2016_2017$y <- as.numeric(chn_eez1_2016_2017$y)
    chn_eez1_2016_2017$x <- as.numeric(chn_eez1_2016_2017$x)
    chn_eez1_2016_2017$eez_admin_rgn <- as.character(chn_eez1_2016_2017$eez_admin_rgn)
    chn_eez1_2016_2017$geartype <- as.character(chn_eez1_2016_2017$geartype)

# 2018-2020 for first code
chn_eez1_2018_2020 <- gfwr::get_raster(spatial_resolution = 'high',
                             temporal_resolution = 'yearly',
                             group_by = 'flagAndGearType',
                             date_range = '2018-01-01,2020-12-31',
                             region = chn_code_eez$id[1],
                             region_source = 'eez',
                             key = key) %>% 
  # rename columns for clarity:
      rename(year = "Time Range",
             apparent_fishing_hours = "Apparent Fishing hours",
             y = Lat,
             x = Lon,
             geartype = Geartype) %>%
      # keep track of the administrative country for each EEZ, even after we combine all data into one dataframe: 
      mutate(eez_admin_rgn = "CHN") %>% 
      select(year, apparent_fishing_hours, y, x, eez_admin_rgn, geartype) # note: we do not care about which region did the actual fishing, just about which country controls that EEZ, which is why we do not maintain the fishing region in the data moving forward
    
    # specify column types before saving the csv so we can correctly concatenate the rows later
    chn_eez1_2018_2020$year <- as.numeric(chn_eez1_2018_2020$year)
    chn_eez1_2018_2020$apparent_fishing_hours <- as.numeric(chn_eez1_2018_2020$apparent_fishing_hours)
    chn_eez1_2018_2020$y <- as.numeric(chn_eez1_2018_2020$y)
    chn_eez1_2018_2020$x <- as.numeric(chn_eez1_2018_2020$x)
    chn_eez1_2018_2020$eez_admin_rgn <- as.character(chn_eez1_2018_2020$eez_admin_rgn)
    chn_eez1_2018_2020$geartype <- as.character(chn_eez1_2018_2020$geartype)
    
# combine data for all 3 time periods into 1 dataframe for this one EEZ code for CHN
chn_eez1_all_years <- bind_rows(chn_eez1_2012_2015, chn_eez1_2016_2017, chn_eez1_2018_2020)

write_csv(chn_eez1_all_years, file = paste0(dir_M, "/git-annex/globalprep/_raw_data/global_fishing_watch/d2022/annual_mapping_api/CHN_", chn_code_eez$id[1], "_effort.csv"))



# the second eez code for China is fine to process over all years
chn_eez2 <- gfwr::get_raster(spatial_resolution = 'high',
                             temporal_resolution = 'yearly',
                             group_by = 'flagAndGearType',
                             date_range = '2012-01-01,2020-12-31',
                             region = chn_code_eez$id[2],
                             region_source = 'eez',
                             key = key) %>% 
# rename columns for clarity:
      rename(year = "Time Range",
             apparent_fishing_hours = "Apparent Fishing hours",
             y = Lat,
             x = Lon,
             geartype = Geartype) %>%
      # keep track of the administrative country for each EEZ, even after we combine all data into one dataframe: 
      mutate(eez_admin_rgn = "CHN") %>% 
      select(year, apparent_fishing_hours, y, x, eez_admin_rgn, geartype) # note: we do not care about which region did the actual fishing, just about which country controls that EEZ, which is why we do not maintain the fishing region in the data moving forward
    
    # specify column types before saving the csv so we can correctly concatenate the rows later
    chn_eez2$year <- as.numeric(chn_eez2$year)
    chn_eez2$apparent_fishing_hours <- as.numeric(chn_eez2$apparent_fishing_hours)
    chn_eez2$y <- as.numeric(chn_eez2$y)
    chn_eez2$x <- as.numeric(chn_eez2$x)
    chn_eez2$eez_admin_rgn <- as.character(chn_eez2$eez_admin_rgn)
    chn_eez2$geartype <- as.character(chn_eez2$geartype)

write_csv(chn_eez2, path = paste0(dir_M, "/git-annex/globalprep/_raw_data/global_fishing_watch/d2022/annual_mapping_api/CHN_", chn_code_eez$id[2], "_effort.csv"))

```

