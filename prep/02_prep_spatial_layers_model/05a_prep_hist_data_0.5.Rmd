---
title: "Prep historical environmental data for 0.5 degrees"
author: "Gage Clawson (IMAS)"
date: '`r format(Sys.time(), "%m/%d/%Y")`'
output: 
  pdf_document: 
    number_sections: yes
    toc: true
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---

# Summary 
Prep historical SST, CHL, and wind data for 0.5 degrees

```{r}
# Load all necessary packages
library(tidyverse)
library(sf)
library(stars)
library(rerddap)
library(rnaturalearth)
library(glue)
library(scico)
library(lubridate)
library(furrr)
library(here)
library(terra)
library(fasterize)
library(raster)
library(janitor)
library(strex)
library(doParallel)

source(here::here("prep/02_prep_spatial_layers_model/_functions_data_wrangling_erddap.R"))
source(here("R/dir.R"))

# Set the data directory. This specifies the folder in our drive where the data can be found. 
data_directory <- rdsi_raw_dir

# Get high-res ocean data
ocean <- ne_download(scale = 50, type = 'ocean', category = 'physical',returnclass = "sf") %>%
  dplyr::select(geometry)

```

# Defining our global grid

```{r}
pixel_size <- 0.5

data_grid <- data.table::fread(here::here("data/model_features/global_grid.csv")) %>%
  st_as_sf(wkt = "geometry_wkt",
           crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") %>%
              mutate(pixel_area_m2 = sf::st_area(geometry_wkt) %>%
                 units::drop_units())


analysis_projection <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"


```


Let's download historical climate data from ISIMIP for surface wind, chl, and sst. We will need to make sure the units are the same and calculate standard deviations as above. 

Chlorophyll: https://data.isimip.org/datasets/49dc048b-29e5-4cde-a89a-2fe448d86476/

SST: https://data.isimip.org/datasets/9e8a4b3f-5a56-4f4c-9677-1737a9f952d7/

Surface wind: https://data.isimip.org/datasets/dbcf73ba-878d-41d4-be7d-e28ce13121bc/ 

CHL and SST are 1 degree, so we will need to disaggregate to 0.5. Surface wind is 0.5, so we just need to resample. 

SST first: 

 - Read in data
 - Resample to match our grid 
 - bias correct with mean for 2014 (matching year)
 - calculate yearly average and save

```{r}
## lets prep SST data. They provide monthly at 60 arc mins (1 degree). We want yearly average and sd. Will need to reproject to our projection likely. 

sst_hist_raw <- rast(file.path(rdsi_raw_dir, "ISIMIP/sst/gfdl-esm4_r1i1p1f1_historical_tos_60arcmin_global_monthly_1850_2014.nc"))
# ok 2219 = 1850, 2383 = 2014. 


## BIAS CORRECTION
sst_obs_2014 <- read.csv(here("data/model_features/ncdcOisst21Agg_LonPM180/errdap_sst_2011_2015.csv")) %>%
  filter(year == 2014) %>%
  left_join(data_grid %>% st_drop_geometry()) %>%
  dplyr::select(lon, lat, sst_c_mean) %>%
  rast(., type = "xyz", crs = analysis_projection)

sst_hist_2014 <- sst_hist_raw[[1980-11:1980]] 

sst_hist_disagg_2014 <- disagg(sst_hist_2014, fact=2, method="bilinear")

sst_hist_resampled_2014 <- resample(sst_hist_disagg_2014, sst_obs_2014, method="bilinear") 


mean_obs_sst <- mean(sst_obs_2014$sst_c_mean, na.rm = TRUE)
mean_isimip_sst <- mean(sst_hist_resampled_2014, na.rm = TRUE)

mean_isimip_sst_project <- terra::project(mean_isimip_sst, analysis_projection)

bias_correction <- mean_obs_sst - mean_isimip_sst_project

sst_hist_disagg <- disagg(sst_hist_raw, fact=2, method="bilinear")

sst_hist_resampled <- resample(sst_hist_disagg, sst_obs_2014, method = "bilinear")

sst_hist_corrected <- sst_hist_resampled + bias_correction

# test <- rast(file.path(rdsi_raw_dir, "ISIMIP/sst/corrected_monthly_1850_2014.nc"))

# plot(mean(sst_hist_corrected[[1980-11:1980]], na.rm = TRUE))
# plot(sst_obs_2014) # PERFECT

# Define time range
start_year <- 1850
end_year <- 2014
desired_start <- 1950

# Compute indices
time_steps_per_year <- 12  # Monthly data
start_index <- (desired_start - start_year) * time_steps_per_year + 1
end_index <- (end_year - start_year + 1) * time_steps_per_year

 
# Subset raster
sst_1950_2014_rast <- sst_hist_corrected[[start_index:end_index]]

sst_1950_2014_monthly <- sst_1950_2014_rast %>%
  as.data.frame(., xy=TRUE) %>% 
    pivot_longer(cols = starts_with("tos_"), names_to = "time_index", values_to = "sst") %>%
    mutate(
    time_index = as.numeric(gsub("tos_", "", time_index)),  # Convert layer number to numeric
    year = 1850 + (time_index - 1) %/% 12,  # Compute year
    month = (time_index - 1) %% 12 + 1  # Compute month
  ) %>%
  dplyr::select(lon = x, lat = y, year, month, sst)

qs::qsave(sst_1950_2014_monthly, file.path(rdsi_raw_dir, "ISIMIP/sst/sst_corrected_1950_2014_monthly_0.5.qs"))

## Now we need to calcualte the yearly mean and sd per pixel 
sst_1950_2014_yearly <- sst_1950_2014_monthly %>%
  left_join(data_grid %>% st_drop_geometry()) %>%
  group_by(pixel_id, year) %>%
  summarise(sst_c_mean = mean(sst, na.rm = TRUE),
            sst_c_sd = sd(sst, na.rm = TRUE)) %>% 
  ungroup()

sst_1950_1980 <- sst_1950_2014_yearly %>%
  filter(year %in% c(1950:1980))

sst_1981_2014 <- sst_1950_2014_yearly %>%
  filter(year %in% c(1981:2014))

qs::qsave(sst_1950_1980, here("data/int/prediction_historical_data/half_degree/sst_yearly_1950_1980.qs")) # its too big for rstudio, need to split it 


qs::qsave(sst_1981_2014, here("data/int/prediction_historical_data/half_degree/sst_yearly_1981_2014.qs")) # its too big for rstudio, need to split it 


```

CHL now: 

 - Read in data
 - Resample to match our grid 
 - bias correct with mean for 2014 (matching year)
 - calculate yearly average and save
 
 - ERRDAP data is surface chlorophyll-a (mg/m3). The ISIMIP data is chlorophyll-a

```{r}
## lets prep chl data. They provide monthly at 60 arc mins (1 degree). We want yearly average and sd. Will need to reproject to our projection likely. 

## why is there so much more data than SST???? Should only be 1980 layers... Is this chlorophyll at different depths?

chl_obs_2014 <- read.csv(here("data/model_features/erdMH1chlamday/errdap_chl_2013_2017.csv")) %>%
  filter(year == 2014) %>%
  left_join(data_grid %>% st_drop_geometry()) %>%
  dplyr::select(lon, lat, chl_mg_per_m3_mean) %>%
  rast(., type = "xyz", crs = analysis_projection)

chl_hist_raw <- rast(file.path(rdsi_raw_dir, "ISIMIP/chl/gfdl-esm4_r1i1p1f1_historical_chl_60arcmin_global_monthly_1850_2014.nc"))
# ok 2219 = 1850, 2383 = 2014. 
# what units? kg/m3. Converted to mg per m3 below
## what is the surface level? Looks like there are different depth levels. I see 2.5, 10, 20, etc; 35 of them? These represent different depths. We want the top depth? 

unique(names(chl_hist_raw))

# test_depths <- grep("_2$", names(chl_hist_raw), value = TRUE)  #I think this is the highest depth (i.e., surface depth?); need to check against the observation data i used
# 35*1980 # 35 depths x 1980 layers. What do the layers represent? Layers are each time step. 1 = 1850 jan, 2 = 1850 feb

surface_chl <- grep("chl_lev=2.5", names(chl_hist_raw), value = TRUE)  #I think this is the highest depth (i.e., surface depth?); need to check against the observation data i used
chl_hist_surface <- chl_hist_raw[[surface_chl]]*1000000
 
chl_hist_surface_disagg <- disagg(chl_hist_surface, fact = 2, method = "bilinear")

chl_hist_surface_resample <- resample(chl_hist_surface_disagg, chl_obs_2014, method = "bilinear")


writeRaster(chl_hist_surface_resample, file.path(rdsi_raw_dir, "ISIMIP/chl/", "resample_surface_chl_1850_2014_mg_m3_0.5.tif"), overwrite=TRUE)

## BIAS CORRECTION
chl_hist_2014 <- chl_hist_surface_resample[[1969:1980]]  # grab only 2014 

mean_obs_chl <- mean(chl_obs_2014, na.rm = TRUE)
mean_isimip_chl <- mean(chl_hist_2014, na.rm = TRUE)

bias_correction <- mean_obs_chl - mean_isimip_chl

chl_hist_corrected <- chl_hist_surface_resample + bias_correction

# plot(mean(chl_hist_corrected[[1969:1980]], na.rm = TRUE))
# plot(chl_obs_2014) # PERFECT

# Define time range
start_year <- 1850
end_year <- 2014
desired_start <- 1950

# Compute indices
time_steps_per_year <- 12  # Monthly data
start_index <- (desired_start - start_year) * time_steps_per_year + 1
end_index <- (end_year - start_year + 1) * time_steps_per_year

 
# Subset raster
chl_1950_2014_rast <- chl_hist_corrected[[start_index:end_index]]

chl_1950_2014_monthly <- chl_1950_2014_rast %>%
  as.data.frame(., xy=TRUE) %>% 
    pivot_longer(cols = starts_with("chl_"), names_to = "time_index", values_to = "chl") %>%
    mutate(
    time_index = as.numeric(strex::str_after_last(time_index, "_")),  # Convert layer number to numeric
    year = 1850 + (time_index - 1) %/% 12,  # Compute year
    month = (time_index - 1) %% 12 + 1  # Compute month
  ) %>%
  left_join(data_grid %>% st_drop_geometry, by = c("x" = "lon", "y" = "lat")) %>%
  dplyr::select(pixel_id, lon = x, lat = y, year, month, chl) 

# test <- chl_1950_2014_monthly %>%
#   dplyr::select(lon, lat, chl) %>%
#   rast(., type = "xyz")
# plot(test)


qs::qsave(chl_1950_2014_monthly, file.path(rdsi_raw_dir, "ISIMIP/chl/chl_corrected_1950_2014_monthly_0.5.qs"))

## Now we need to calcualte the yearly mean and sd per pixel 
chl_1950_2014_yearly <- chl_1950_2014_monthly %>%
  group_by(pixel_id, year) %>%
  summarise(chl_mg_per_m3_mean = mean(chl, na.rm = TRUE),
            chl_mg_per_m3_sd = sd(chl, na.rm = TRUE)) %>% 
  ungroup()

# qs::qsave(chl_1950_2014_yearly, here("data/int/prediction_historical_data/half_degree/chl_yearly_1950_2014.qs")) # NICE! Only 32 MB


chl_1950_1980 <- chl_1950_2014_yearly %>%
  filter(year %in% c(1950:1980))

chl_1981_2014 <- chl_1950_2014_yearly %>%
  filter(year %in% c(1981:2014))

qs::qsave(chl_1950_1980, here("data/int/prediction_historical_data/half_degree/chl_yearly_1950_1980.qs")) # its too big for rstudio, need to split it 


qs::qsave(chl_1981_2014, here("data/int/prediction_historical_data/half_degree/chl_yearly_1981_2014.qs")) # its too big for rstudio, need to split it 


```

Now prep wind data 

```{r}
## lets prep wind data. They provide monthly at 0.5 degree. We want yearly average and sd. Will need to reproject to our projection likely. 

wind_obs_2014 <- read.csv(here("data/model_features/remss_wind/wind_2013_2017.csv")) %>%
  filter(year == 2014) %>%
  left_join(data_grid %>% st_drop_geometry()) %>%
  dplyr::select(lon, lat, wind_speed_ms_mean) %>%
  rast(., type = "xyz", crs = analysis_projection)

bias_mean <- rast(file.path(rdsi_raw_dir, "ISIMIP/wind/mean_bias_rast.tif"))

# then bias adjust daily ocean 0.5 data, calculate yearly averages, resample yearly averages to our grid, and extract as data frames to save 

## now calculate yearly averages and resample to our raster format save rasters for those years 
hist_files <- list.files(file.path(rdsi_raw_dir, "ISIMIP/wind/ocean"), pattern = "_ocean", full.names = TRUE)



for(file in hist_files[2:8]) {
 # file <- hist_files[1]
  ocean_hist_wind <- rast(file)
 
# Use regular expression to extract the start and end years
years <- sub(".*_([0-9]{4})_([0-9]{4}).*.tif", "\\1-\\2", file)

# Split the years into individual components
year_split <- as.integer(strsplit(years, "-")[[1]])

# Extract min and max years
min_year <- min(year_split)
max_year <- max(year_split)  
days_per_year <- 365
  
yearly_avg_rasters <- c()
yearly_sd_rasters <- c()
   
  # Loop through each year and calculate the yearly average
for (i in seq_along(min_year:max_year)) {
  # i = 1
  # Extract the layers corresponding to the current year
  start_layer <- (i - 1) * days_per_year + 1
  end_layer <- i * days_per_year
  year_layers <- ocean_hist_wind[[start_layer:end_layer]]
  
  # Calculate the yearly average for that year
  yearly_avg_rasters[[i]] <- mean(year_layers, na.rm = TRUE)
  yearly_sd_rasters[[i]] <- app(year_layers, fun = sd, na.rm = TRUE)
}

# Stack the yearly averages into a single raster
yearly_avg_raster_stack <- rast(yearly_avg_rasters)
yearly_sd_raster_stack <- rast(yearly_sd_rasters)

# resample to match our raster
yearly_avg_raster_stack_resamp <- resample(yearly_avg_raster_stack, wind_obs_2014, method = "bilinear")
yearly_avg_raster_stack_resamp <- terra::project(yearly_avg_raster_stack_resamp, wind_obs_2014)

yearly_sd_raster_stack_resamp <- resample(yearly_sd_raster_stack, wind_obs_2014, method = "bilinear")
yearly_sd_raster_stack_resamp <- terra::project(yearly_sd_raster_stack_resamp, wind_obs_2014)

# Name the layers of the stacked raster by the year
names(yearly_avg_raster_stack_resamp) <- paste0(min_year:max_year)
names(yearly_sd_raster_stack_resamp) <- paste0(min_year:max_year)

# Save the raster stack to a file (optional)
writeRaster(yearly_avg_raster_stack_resamp, file.path(rdsi_raw_dir, glue("ISIMIP/wind/yearly_wind_averages_{min_year}_{max_year}_bias_corrected_0.5.tif")), overwrite=TRUE)

writeRaster(yearly_sd_raster_stack_resamp, file.path(rdsi_raw_dir, glue("ISIMIP/wind/yearly_wind_sd_{min_year}_{max_year}_bias_corrected_0.5.tif")), overwrite=TRUE)

}
  

## now save as.data.frame() for each year
hist_files_mean <- list.files(file.path(rdsi_raw_dir, "ISIMIP/wind/"), pattern = "bias_corrected_0.5", full.names = TRUE)[1:8]
hist_files_sd <- list.files(file.path(rdsi_raw_dir, "ISIMIP/wind/"), pattern = "bias_corrected_0.5", full.names = TRUE)[9:16]

  
  hist_rast_df_mean <- rast(hist_files_mean) %>%
    resample(., wind_obs_2014, method = "bilinear") %>%
    as.data.frame(., xy = TRUE) %>%
    pivot_longer(cols = 3:76,
                 names_to = c("year"),
                 values_to = c("wind_speed_ms_mean")) %>%
    filter(year >= 1950) %>%
    left_join(data_grid %>% st_drop_geometry(), by = c("x" = "lon", "y" = "lat")) %>%
        dplyr::select(pixel_id, year, wind_speed_ms_mean) %>%
    filter(!is.na(pixel_id))

  
  
  hist_rast_df_sd <- rast(hist_files_sd) %>%
    resample(., wind_obs_2014, method = "bilinear") %>%
    as.data.frame(., xy = TRUE) %>%
    pivot_longer(cols = 3:76,
                 names_to = c("year"),
                 values_to = c("wind_speed_ms_sd")) %>%
    filter(year >= 1950) %>%
    left_join(data_grid %>% st_drop_geometry(), by = c("x" = "lon", "y" = "lat")) %>%
    dplyr::select(pixel_id, year, wind_speed_ms_sd) %>%
    filter(!is.na(pixel_id))


  
  hist_rast_all <- hist_rast_df_mean %>%
    left_join(hist_rast_df_sd)
  
  qs::qsave(hist_rast_all, here("data/int/prediction_historical_data/half_degree/wind_yearly_1950_2014.qs")) # wonder why its smaller than the sst and chl? 
  
  test <- hist_rast_df_mean %>%
    filter(year == 1950) # looks good 
  
```
